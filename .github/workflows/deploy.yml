name: 🚀 Auto-Deploy to EC2 (Port 80, Stable)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4

      - name: Build and deploy container
        shell: bash
        run: |
          set -euo pipefail
          echo "🚀 Starting Zero-Downtime Deployment to EC2..."

          # Prepare app directory
          mkdir -p ~/app
          cp -f $GITHUB_WORKSPACE/app.py $GITHUB_WORKSPACE/Dockerfile ~/app/

          cd ~/app

          echo "🧱 Building Docker image..."
          docker build -t myflaskapp:latest .

          echo "🧹 Cleaning old temporary containers..."
          docker rm -f myflaskapp_new 2>/dev/null || true
          docker image prune -f 2>/dev/null || true

          echo "⚙️ Running new container on test port 8082..."
          docker run -d -p 8082:8080 --name myflaskapp_new myflaskapp:latest

          echo "⏳ Health check for new container..."
          for i in {1..20}; do
            if curl -fsS http://localhost:8082 >/dev/null; then
              echo "✅ New app is healthy!"
              break
            fi
            sleep 1
          done

          echo "🔥 Swapping old container with new one..."
          docker rm -f myflaskapp 2>/dev/null || true
          docker run -d -p 80:8080 --name myflaskapp myflaskapp:latest
          docker rm -f myflaskapp_new 2>/dev/null || true

          echo "🔍 Deployment complete. Current running containers:"
          docker ps

          echo "🌍 App live at: http://16.16.185.223 or your AWS domain"
