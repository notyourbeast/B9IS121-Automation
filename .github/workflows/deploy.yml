name: Deploy to EC2 Docker

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and deploy container
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸš€ Deploying on EC2â€¦"

          # Prepare app directory
          mkdir -p ~/app
          cp -f $GITHUB_WORKSPACE/app.py $GITHUB_WORKSPACE/Dockerfile ~/app/

          cd ~/app

          echo "ğŸ›  Building Docker image..."
          docker build -t myflaskapp:latest .

          echo "ğŸ§¹ Stopping and removing old container (if any)..."
          docker rm -f myflaskapp || true

          echo "ğŸª„ Starting new container..."
          docker run -d -p 8080:8080 --name myflaskapp myflaskapp:latest

          echo "â³ Waiting for app to be ready..."
          for i in {1..20}; do
            if curl -fsS http://localhost:8080/ >/dev/null; then
              echo "âœ… App is up!"
              break
            fi
            sleep 1
          done

          echo "ğŸ” Docker container status:"
          docker ps

          echo "ğŸ”— Testing endpoint response:"
          curl -fsS http://localhost:8080/ | head -n1
