name: Zero-Downtime Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4

      - name: Zero-Downtime Deployment
        run: |
          set -e

          echo "🚀 Pulling latest code..."
          cd ~/B9IS121-Automation
          git fetch origin main
          git reset --hard origin/main

          echo "🧱 Building new Docker image..."
          docker build -t myflaskapp:latest .

          echo "🌍 Checking if old container is running..."
          if [ "$(docker ps -q -f name=myflaskapp)" ]; then
            echo "⚙️  Running new container temporarily on port 8081..."
            docker run -d -p 8081:8080 --name myflaskapp_new myflaskapp:latest

            echo "⏳ Waiting 5 seconds for startup..."
            sleep 5

            echo "🧠 Health check..."
            if curl -fsS http://localhost:8081 >/dev/null; then
              echo "✅ New container healthy. Replacing old one..."
              docker stop myflaskapp
              docker rm myflaskapp
              docker rename myflaskapp_new myflaskapp
              echo "🔥 Swapped successfully with zero downtime!"
            else
              echo "❌ New build failed health check. Keeping old container."
              docker stop myflaskapp_new
              docker rm myflaskapp_new
            fi
          else
            echo "🧱 No old container found — starting new one on port 80..."
            docker run -d -p 80:8080 --name myflaskapp myflaskapp:latest
          fi

          echo "✅ Deployment complete!"
