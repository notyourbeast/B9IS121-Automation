name: Zero-Downtime Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4

      - name: Build and deploy container
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸš€ Deploying on EC2â€¦"

          # Prepare app directory
          mkdir -p ~/app
          cp -f $GITHUB_WORKSPACE/app.py $GITHUB_WORKSPACE/Dockerfile ~/app/

          cd ~/app

          echo "ğŸ›  Building Docker image..."
          docker build -t myflaskapp:latest .

          echo "ğŸ§¹ Cleaning old containers..."
          docker rm -f myflaskapp_new 2>/dev/null || true
          docker image prune -f 2>/dev/null || true

          echo "âš™ï¸  Running new container temporarily on port 8082..."
          docker run -d -p 8082:8080 --name myflaskapp_new myflaskapp:latest

          echo "â³ Waiting for app to be ready..."
          for i in {1..20}; do
            if curl -fsS http://localhost:8082/ >/dev/null; then
              echo "âœ… New app is healthy!"
              break
            fi
            sleep 1
          done

          echo "ğŸ”¥ Swapping live container..."
          docker rm -f myflaskapp 2>/dev/null || true
          docker rename myflaskapp_new myflaskapp

          echo "ğŸ” Docker status:"
          docker ps

