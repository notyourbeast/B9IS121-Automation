name: Deploy to EC2 Docker

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and deploy container
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸš€ Deploying on EC2â€¦"
          mkdir -p ~/app
          cp -f app.py Dockerfile ~/app/

          cd ~/app
          docker build -t myflaskapp:latest .

            # stop and remove existing container if running

          # run mapping host:80 -> container:8080 (public) and host:8080 -> container:8080 (optional)
          docker run -d -p 8080:8080 --name myflaskapp:latest

          echo "â³ Waiting for app to be readyâ€¦"
          for i in {1..20}; do
            if curl -fsS http://localhost/ >/dev/null; then
              echo "âœ… App is up"
              break
            fi
            sleep 1
          done

          # final check + show brief docker info
          curl -fsS http://localhost/ | head -n1
          docker ps